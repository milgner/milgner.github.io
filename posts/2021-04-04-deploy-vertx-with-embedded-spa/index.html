<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta name=author content="Marcus Ilgner"><meta name=description content="Deploy a Vert.x application with an embedded SPA    As a developer I have come to enjoy the versatility and power of the Vert.x platform. And although it contains many utilities for server-side rendering, called Vert.x Web, there are situations where you might want to use a single-page application (SPA) instead.
Concrete reasons for and against SPAs are best kept separate from this. One thing, however, that makes SPAs cumbersome for small teams is having to deploy them separately from the API they will talk to, so having a setup that allows for deploying everything in one go."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploy a Vert.x app with an embedded SPA"><meta name=twitter:description content="Deploy a Vert.x application with an embedded SPA    As a developer I have come to enjoy the versatility and power of the Vert.x platform. And although it contains many utilities for server-side rendering, called Vert.x Web, there are situations where you might want to use a single-page application (SPA) instead.
Concrete reasons for and against SPAs are best kept separate from this. One thing, however, that makes SPAs cumbersome for small teams is having to deploy them separately from the API they will talk to, so having a setup that allows for deploying everything in one go."><meta property="og:title" content="Deploy a Vert.x app with an embedded SPA"><meta property="og:description" content="Deploy a Vert.x application with an embedded SPA    As a developer I have come to enjoy the versatility and power of the Vert.x platform. And although it contains many utilities for server-side rendering, called Vert.x Web, there are situations where you might want to use a single-page application (SPA) instead.
Concrete reasons for and against SPAs are best kept separate from this. One thing, however, that makes SPAs cumbersome for small teams is having to deploy them separately from the API they will talk to, so having a setup that allows for deploying everything in one go."><meta property="og:type" content="article"><meta property="og:url" content="https://marcusilgner.com/posts/2021-04-04-deploy-vertx-with-embedded-spa/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-05T13:31:04+02:00"><meta property="article:modified_time" content="2021-04-05T13:31:04+02:00"><title>Deploy a Vert.x app with an embedded SPA · Marcus Ilgner</title><link rel=canonical href=https://marcusilgner.com/posts/2021-04-04-deploy-vertx-with-embedded-spa/><link rel=preload href="https://marcusilgner.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://marcusilgner.com/css/coder.min.93c41bf1e522f85ecda7355985f09000f71fc1d64dda9f74051b0fa06210e93f.css integrity="sha256-k8Qb8eUi+F7NpzVZhfCQAPcfwdZN2p90BRsPoGIQ6T8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://marcusilgner.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://marcusilgner.com/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://marcusilgner.com/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://marcusilgner.com/images/apple-touch-icon.png><script defer src=https://twemoji.maxcdn.com/v/13.0.2/twemoji.min.js integrity=sha384-wyB/MspSJ/r2bT2kCj44qtsYRYlpzO2oAPhRj5myrWD63dt6qWv4x8AZe7Fl3K3b crossorigin=anonymous></script><meta name=generator content="Hugo 0.96.0"></head><body class="preload-transitions colorscheme-light" onload=twemoji.parse(document.body)><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://marcusilgner.com/>Marcus Ilgner</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://marcusilgner.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://marcusilgner.com/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://marcusilgner.com/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://marcusilgner.com/posts/2021-04-04-deploy-vertx-with-embedded-spa/>Deploy a Vert.x app with an embedded SPA</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2021-04-05T13:31:04+02:00>April 5, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://marcusilgner.com/tags/vert.x/>Vert.x</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://marcusilgner.com/tags/vue-3/>Vue 3</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://marcusilgner.com/tags/kotlin/>Kotlin</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://marcusilgner.com/tags/gradle/>Gradle</a></span></div></div></header><div><h1 id=deploy-a-vertx-application-with-an-embedded-spa>Deploy a Vert.x application with an embedded SPA
<a class=heading-link href=#deploy-a-vertx-application-with-an-embedded-spa><i class="fa fa-link" aria-hidden=true></i></a></h1><p>As a developer I have come to enjoy the versatility and power of the <a href=https://vertx.io/>Vert.x</a> platform. And although it contains many utilities for server-side rendering, called <a href=https://vertx.io/docs/vertx-web/java/>Vert.x Web</a>, there are situations where you might want to use a single-page application (SPA) instead.</p><p>Concrete reasons for and against SPAs are best kept separate from this. One thing, however, that makes SPAs cumbersome for small teams is having to deploy them separately from the API they will talk to, so having a setup that allows for deploying everything in one go.</p><p>As such, here are a few tips for setting up your project so that the SPA will be deployed along with the rest of your application as static resources: a single <code>.jar</code> file that includes everything required to run the application.</p><h3 id=setting-up>Setting up
<a class=heading-link href=#setting-up><i class="fa fa-link" aria-hidden=true></i></a></h3><p>To get the basic directory structure going, it&rsquo;s easiest to go to <a href=https://start.vertx.io/><code>start.vertx.io</code></a>. As the language of choice I chose Kotlin. Also, we&rsquo;ll use the Gradle build system.</p><p>After extracting the generated archive, you&rsquo;ll have the following file and directory structure (only listing those files that will be of interest during the rest of this article):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>build.gradle.kts        
</span></span><span style=display:flex><span>src/
</span></span><span style=display:flex><span>src/main/
</span></span><span style=display:flex><span>src/main/kotlin/com/example/starter/MainVerticle.kt  
</span></span><span style=display:flex><span>src/test/
</span></span><span style=display:flex><span>gradlew.bat             
</span></span><span style=display:flex><span>gradlew                 
</span></span></code></pre></div><p>The infrastructure for building and running the JVM application is prepared now and <code>./gradlew run</code> will start it up. Feel free to try this and point your browser to <code>http://localhost:8888/</code>. There you should see &ldquo;Hello from Vert.x!&rdquo; Great!</p><h3 id=adding-the-spa>Adding the SPA
<a class=heading-link href=#adding-the-spa><i class="fa fa-link" aria-hidden=true></i></a></h3><p>The SPA will be built separately from the JVM-based projects. You might even want to put it into a separate repository (using Git submodules) and it usually contains the tests as part of its folder structure. That is why we&rsquo;ll place it into a separate folder called <code>src/webapp</code>, next to the <code>src/main</code> and <code>src/test</code> directories.</p><p>To easily bootstrap this part, open a shell in the <code>src</code> directory and run <code>npm init @vitejs/app webapp</code>. Choose a flavour of your choice (I usually prefer <code>vue-ts</code>) and witness the <code>webapp</code> directory being created.
If you want to test whether everything worked, you can follow the instructions shown on the screen:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>cd webapp
</span></span><span style=display:flex><span>npm install
</span></span><span style=display:flex><span>npm run dev
</span></span></code></pre></div><p>And you should finally see</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&gt; webapp@0.0.0 dev /tmp/src/webapp
</span></span><span style=display:flex><span>&gt; vite
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Pre-bundling dependencies:
</span></span><span style=display:flex><span>  vue
</span></span><span style=display:flex><span>(this will be run only when your dependencies or config have changed)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  vite v2.1.5 dev server running at:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  &gt; Local:    http://localhost:3000/
</span></span><span style=display:flex><span>  &gt; Network:  http://[YOUR-NETWORK-IP]:3000/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ready in 205ms.
</span></span></code></pre></div><p>Open your browser at <code>http://localhost:3000/</code> and after confirming that this does work indeed, we can stop the web server again. This server automatically hot-reloads any changes made on the fly will be used during development of the SPA.</p><h2 id=building-the-spa-along-with-the-vertx-application>Building the SPA along with the Vert.x application
<a class=heading-link href=#building-the-spa-along-with-the-vertx-application><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Now for the tasty bits: what we ultimately want is that the application doesn&rsquo;t just say &ldquo;Hello from Vert.x!&rdquo; anymore but instead serves up the compiled SPA.
For this to work, three steps are necessary:</p><ol><li>the SPA needs to be built along the JVM code</li><li>the generated HTML & JS need to be bundled into the <code>.jar</code> file</li><li>the Vert.x application needs to serve up the generated assets</li></ol><p>So, let&rsquo;s get to work!</p><h3 id=building-the-spa-with-gradle>Building the SPA with Gradle
<a class=heading-link href=#building-the-spa-with-gradle><i class="fa fa-link" aria-hidden=true></i></a></h3><p>In order to integrate the NPM build process into the existing configuration, we&rsquo;ll use a <a href=https://github.com/node-gradle/gradle-node-plugin>Gradle Plugin for integration NodeJS</a>. Add it to the <code>plugins</code> section of your <code>build.gradle.kts</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>plugins {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  id(<span style=color:#e6db74>&#34;com.github.node-gradle.node&#34;</span>) version <span style=color:#e6db74>&#34;3.0.1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we can configure the build cycle and integrate the build process:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>node {
</span></span><span style=display:flex><span>  nodeProjectDir.<span style=color:#66d9ef>set</span>(<span style=color:#66d9ef>file</span>(<span style=color:#e6db74>&#34;src/webapp&#34;</span>))
</span></span><span style=display:flex><span>  npmInstallCommand.<span style=color:#66d9ef>set</span>(<span style=color:#66d9ef>if</span> (getenv(<span style=color:#e6db74>&#34;CI&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) { <span style=color:#e6db74>&#34;ci&#34;</span> } <span style=color:#66d9ef>else</span> { <span style=color:#e6db74>&#34;install&#34;</span> })
</span></span><span style=display:flex><span>  download.<span style=color:#66d9ef>set</span>(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tasks.register&lt;NpxTask&gt;(<span style=color:#e6db74>&#34;buildFrontEnd&#34;</span>) {
</span></span><span style=display:flex><span>  dependsOn(<span style=color:#e6db74>&#34;npmInstall&#34;</span>)
</span></span><span style=display:flex><span>  inputs.files(fileTree(<span style=color:#e6db74>&#34;src/webapp/src&#34;</span>))
</span></span><span style=display:flex><span>  outputs.dir(<span style=color:#e6db74>&#34;build/resources/main/webapp&#34;</span>)
</span></span><span style=display:flex><span>  command.<span style=color:#66d9ef>set</span>(<span style=color:#e6db74>&#34;vite&#34;</span>)
</span></span><span style=display:flex><span>  args.<span style=color:#66d9ef>set</span>(listOf(<span style=color:#e6db74>&#34;build&#34;</span>, <span style=color:#e6db74>&#34;--mode&#34;</span>, <span style=color:#e6db74>&#34;production&#34;</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This configures the <code>node</code> plugin by pointing it to the previously-generated <code>src/webapp</code> directory. NPM dependencies will be installed using <code>npm install</code> on regular systems and <code>npm ci</code> when running on CI systems.
Also, I decided to disable downloading of Node.js distributions via this plugin because I usually prefer to do this separately.</p><p>Finally, we&rsquo;ll need to ensure that the newly-created <code>buildFrontEnd</code> task is invoked along with the existing build steps. I chose the following configuration for now, but will still have to look more closely at that part to determine whether there are better alternatives.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>tasks.named(<span style=color:#e6db74>&#34;build&#34;</span>) {
</span></span><span style=display:flex><span>  dependsOn(<span style=color:#e6db74>&#34;buildFrontEnd&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tasks.named(<span style=color:#e6db74>&#34;assemble&#34;</span>) {
</span></span><span style=display:flex><span>  dependsOn(<span style=color:#e6db74>&#34;buildFrontEnd&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tasks.named(<span style=color:#e6db74>&#34;run&#34;</span>) {
</span></span><span style=display:flex><span>  dependsOn(<span style=color:#e6db74>&#34;build&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Done. Now the SPA will be built and packaged along with the rest of the application.</p><h3 id=serving-the-spa-with-vertx>Serving the SPA with Vert.x
<a class=heading-link href=#serving-the-spa-with-vertx><i class="fa fa-link" aria-hidden=true></i></a></h3><p>Only one step left: the compiled application will need to be served via Vert.x. Open up the generated <code>MainVerticle.kt</code> and adapt its implementation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainVerticle</span> : AbstractVerticle() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>start</span>(startPromise: Promise&lt;Void&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> router = Router.router(vertx)
</span></span><span style=display:flex><span>    router.route(<span style=color:#e6db74>&#34;/*&#34;</span>).handler(StaticHandler.create(<span style=color:#e6db74>&#34;webapp&#34;</span>))
</span></span><span style=display:flex><span>    router.<span style=color:#66d9ef>get</span>().handler { routingContext: RoutingContext <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>      routingContext.response().sendFile(<span style=color:#e6db74>&#34;webapp/index.html&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    vertx
</span></span><span style=display:flex><span>      .createHttpServer()
</span></span><span style=display:flex><span>      .requestHandler(router)
</span></span><span style=display:flex><span>      .listen(<span style=color:#ae81ff>8888</span>) { asyncResult <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (asyncResult.succeeded()) {
</span></span><span style=display:flex><span>          startPromise.complete()
</span></span><span style=display:flex><span>          println(<span style=color:#e6db74>&#34;HTTP server started on port 8888&#34;</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          startPromise.fail(asyncResult.cause());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you look back at the Gradle configuration, you will see that the SPA will be compiled into the <code>webapp</code> directory inside the bundle:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>  outputs.dir(<span style=color:#e6db74>&#34;build/resources/main/webapp&#34;</span>)
</span></span></code></pre></div><p>This directory is served from the root of the Vert.x application. Also, we&rsquo;ll set up a backup-route that will serve the generated <code>index.html</code> whenever there isn&rsquo;t any other matching route. This will allow our SPA to use arbitrary routes and deep links without being forced to only used client-side hash-based routing.</p><p>That&rsquo;s it: if you now invoke <code>./gradlew run</code> again, you will see the SPA being served on port 8888, i.e. <code>http://localhost:8888</code>. Congratulations, you now have everything you need to easily deploy a Vert.x-based application with a Node.js-based SPA front-end. 🥳</p></div><footer><section class=see-also></section></footer></article></section></div><footer class=footer><section class=container>©
2018 -
2022
Marcus Ilgner
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=https://marcusilgner.com/js/coder.min.f48f8b52310e1a89d74558ac6718cde27d388efc7f13bd1cec79598a4fadce38.js integrity="sha256-9I+LUjEOGonXRVisZxjN4n04jvx/E70c7HlZik+tzjg="></script>
<script src=https://marcusilgner.com/scripts/mermaid.min.js></script>
<script src=https://marcusilgner.com/scripts/init.js></script></body></html>